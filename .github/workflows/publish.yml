# Filename: .github/workflows/publish.yml

name: Render, Commit MDs, and Deploy Website

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  # Source of Truth (R-Paket Struktur)
  SRC_PATH: "inst/rstudio/templates/project/skeleton/_extensions/orehren/acvt"
  # Target für Quarto CLI (Root)
  ROOT_EXT_PATH: "_extensions/acvt"

jobs:
  publish-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Quarto and R
        uses: quarto-dev/quarto-actions/setup@v2

      # --- SCHRITT 1: Synchronisierung (inst -> root) ---
      - name: Sync Extension and Template Files to Root
        run: |
          echo "Synchronizing extension from inst/ to root..."
          
          # 1. Extension Ordner syncen
          rm -rf _extensions
          mkdir -p "$ROOT_EXT_PATH"
          cp -r "$SRC_PATH/"* "$ROOT_EXT_PATH/"
          
          # 2. Template Dateien (Quarto Config & QMD) ins Root kopieren
          # Wir kopieren sie aus dem SRC_PATH direkt in das aktuelle Verzeichnis (.)
          echo "Copying template files (_quarto.yml, academicCV-template.qmd) to Repo Root..."
          
          cp "$SRC_PATH/_quarto.yml" ./_quarto.yml
          cp "$SRC_PATH/academicCV-template.qmd" ./academicCV-template.qmd

          echo "Sync abgeschlossen."
          ls -la
        shell: bash

      # --- SCHRITT 2: Dateien vorbereiten (Patching) ---
      - name: Prepare Source Files (Patch Config & Clear Metadata)
        run: |
          CONF_FILE="$ROOT_EXT_PATH/_extension.yml"
          TYP_FILE="$ROOT_EXT_PATH/typst/02-definitions-metadata.typ"

          echo "Patching Configuration: $CONF_FILE"
          
          # Pfad auf Root-Struktur anpassen
          sed -i 's|: .*_fetch_cv_data\.R|: _extensions/orehren/acvt/R/_fetch_cv_data.R|' "$CONF_FILE"

          if [ -f "$TYP_FILE" ]; then
            echo "Clearing Metadata: $TYP_FILE"
            truncate -s 0 "$TYP_FILE"
          fi

          # Patch zurück in die Source kopieren (damit Sync konsistent bleibt)
          cp "$CONF_FILE" "$SRC_PATH/_extension.yml"
          cp "$TYP_FILE" "$SRC_PATH/typst/02-definitions-metadata.typ"
        shell: bash

      - name: Render Quarto Website
        uses: quarto-dev/quarto-actions/render@v2
        with:
          path: docs

      # --- SCHRITT 3: Markdown Dateien bewegen ---
      - name: Move intermediate Markdown files and Re-Sync
        run: |
          DOCS_TARGET="$SRC_PATH/docs"
          mkdir -p "$DOCS_TARGET"
          
          echo "Moving generated markdown files to Source of Truth ($DOCS_TARGET)..."
          find docs/ -type f -name "*.md" -exec mv {} "$DOCS_TARGET/" \;
          
          echo "Re-Syncing updated files from Source to Root..."
          cp -r "$SRC_PATH/docs" "$ROOT_EXT_PATH/"
        shell: bash

      - name: Commit changes back to main
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # 1. Source of Truth adden
          git add -f "$SRC_PATH/docs/*.md"
          git add -f "$SRC_PATH/_extension.yml"
          git add -f "$SRC_PATH/typst/02-definitions-metadata.typ"
          
          # 2. Root Extension adden
          git add -f _extensions

          # 3. Template Dateien im Root adden (NEU)
          git add -f _quarto.yml
          git add -f academicCV-template.qmd

          if git diff --staged --quiet; then
            echo "Keine Änderungen zu committen."
          else
            git commit -m "Docs: Auto-sync inst to root & update markdowns [skip ci]"
            git push
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs/_site
          publish_branch: gh-pages
          force_orphan: true