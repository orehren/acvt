# Filename: .github/workflows/publish.yml

name: Render, Commit MDs, and Deploy Website

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  # Source of Truth (R package structure)
  # SRC_PATH: "inst/rstudio/templates/project/skeleton/_extensions/orehren/acvt"
  SRC_PATH: "inst/rstudio/templates/project/skeleton/_extensions/acvt"
  # Target for Quarto CLI (Root)
  ROOT_EXT_PATH: "_extensions/acvt"

jobs:
  publish-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Quarto and R
        uses: quarto-dev/quarto-actions/setup@v2

      # --- STEP 1: Synchronizing (inst -> root) ---
      - name: Sync Extension and Template Files to Root
        run: |
          echo "Synchronizing extension from inst/ to root..."

          # 1. Extension Folder syncing
          rm -rf _extensions
          mkdir -p "$ROOT_EXT_PATH"
          cp -r "$SRC_PATH/"* "$ROOT_EXT_PATH/"

          # 2. Copy Template Files (Quarto Config & QMD) into Root
          echo "Copying template files (_quarto.yml, Academic-CV-template.qmd) to Repo Root..."

          cp "$SRC_PATH/_quarto.yml" ./_quarto.yml
          cp "$SRC_PATH/Academic-CV-template.qmd" ./Academic-CV-template.qmd

          echo "Sync finished."
          ls -la
        shell: bash

      # --- STEP 2: Prepare Files (Patching) ---
      - name: Prepare Source Files (Patch Config & Clear Metadata)
        run: |
          CONF_FILE="$ROOT_EXT_PATH/_extension.yml"

          echo "Patching Configuration: $CONF_FILE"

          # edit path to match extension root
          # sed -i 's|: .*_fetch_cv_data\.R|: _extensions/orehren/acvt/R/_fetch_cv_data.R|' "$CONF_FILE"
          sed -i 's|: .*_fetch_cv_data\.R|: _extensions/acvt/R/_fetch_cv_data.R|' "$CONF_FILE"

          # copy patch back in to the source to keep sync consistent
          cp "$CONF_FILE" "$SRC_PATH/_extension.yml"
        shell: bash

      - name: Render Quarto Website
        uses: quarto-dev/quarto-actions/render@v2
        with:
          path: docs

      # --- STEP 3: Move Markdown Files ---
      - name: Move intermediate Markdown files and Re-Sync
        run: |
          DOCS_TARGET="$SRC_PATH/docs"
          mkdir -p "$DOCS_TARGET"

          echo "Moving generated markdown files to Source of Truth ($DOCS_TARGET)..."
          find docs/ -type f -name "*.md" -exec mv {} "$DOCS_TARGET/" \;

          echo "Re-Syncing updated files from Source to Root..."
          cp -r "$SRC_PATH/docs" "$ROOT_EXT_PATH/"
        shell: bash

      - name: Commit changes back to main
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # 1. Add Source of Truth
          git add -f "$SRC_PATH/docs/*.md"
          git add -f "$SRC_PATH/_extension.yml"

          # 2. Add Root Extension
          git add -f _extensions

          # 3. Add Template Files to Root
          git add -f _quarto.yml
          git add -f Academic-CV-template.qmd

          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Docs: Auto-sync inst to root & update markdowns [skip ci]"
            git push
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs/_site
          publish_branch: gh-pages
          force_orphan: true
